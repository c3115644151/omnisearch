import { ref, onBeforeUnmount, onMounted, computed } from "vue";
import { i as inBrowser } from "../util/env.js";
const observerMap = /* @__PURE__ */ new WeakMap();
const observerCallbacksMap = /* @__PURE__ */ new WeakMap();
const runCallbacks = (observed) => {
  return () => {
    const list = observerCallbacksMap.get(observed);
    list == null ? void 0 : list.forEach((func) => func());
  };
};
const useDarkMode = () => {
  const darkMode = ref(false);
  const darkModeHtml = ref(void 0);
  function handleDarkModeChange(e) {
    darkMode.value = e.matches;
  }
  if (inBrowser()) {
    const darkModeQuery = window.matchMedia("(prefers-color-scheme: dark)");
    handleDarkModeChange(darkModeQuery);
    darkModeQuery.addEventListener("change", handleDarkModeChange);
    onBeforeUnmount(() => {
      darkModeQuery.removeEventListener("change", handleDarkModeChange);
    });
  }
  const callback = () => {
    if (inBrowser()) {
      let hasDark = false, hasLight = false;
      document.documentElement.className.split(" ").forEach((cls) => {
        if (cls === "dark") {
          hasDark = true;
        }
        if (cls === "light") {
          hasLight = true;
        }
      });
      darkModeHtml.value = hasDark ? true : hasLight ? false : void 0;
    }
  };
  if (inBrowser()) {
    onMounted(() => {
      const observer = observerMap.get(document.documentElement) || new MutationObserver(runCallbacks(document.documentElement));
      observerMap.set(document.documentElement, observer);
      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ["class"]
      });
      observerCallbacksMap.set(document.documentElement, [
        ...observerCallbacksMap.get(document.documentElement) || [],
        callback
      ]);
      callback();
    });
    onBeforeUnmount(() => {
      observerCallbacksMap.set(
        document.documentElement,
        (observerCallbacksMap.get(document.documentElement) || []).filter(
          (func) => func !== callback
        )
      );
    });
  }
  return computed(() => {
    return darkModeHtml.value ?? darkMode.value;
  });
};
export {
  useDarkMode as u
};
